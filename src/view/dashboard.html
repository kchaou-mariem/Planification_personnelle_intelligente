<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau de bord - Planification Personnelle</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <div class="page-wrapper">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">üìÖ</div>
                <span class="sidebar-brand">Planificateur</span>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Menu</div>
                    <a href="dashboard.html" class="nav-item active">
                        <span class="nav-icon">üìä</span>
                        <span class="nav-label">Tableau de bord</span>
                    </a>
                    <a href="activites.html" class="nav-item">
                        <span class="nav-icon">üìå</span>
                        <span class="nav-label">Activit√©s</span>
                    </a>
                    <a href="contraintes.html" class="nav-item">
                        <span class="nav-icon">‚è∞</span>
                        <span class="nav-label">Contraintes</span>
                    </a>
                    <a href="conflits.html" class="nav-item">
                        <span class="nav-icon">‚ö†Ô∏è</span>
                        <span class="nav-label">Conflits</span>
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Param√®tres</div>
                    <a href="profil.html" class="nav-item">
                        <span class="nav-icon">üë§</span>
                        <span class="nav-label">Mon profil</span>
                    </a>
                    <a href="#" class="nav-item" onclick="Utils.toggleTheme(); return false;">
                        <span class="nav-icon">üåì</span>
                        <span class="nav-label">Th√®me</span>
                    </a>
                </div>
            </nav>

            <div class="sidebar-footer">
                <div class="user-card" id="userCard">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <div class="user-info">
                        <div class="user-name" id="userName">Utilisateur</div>
                        <div class="user-email" id="userEmail">email@example.com</div>
                    </div>
                </div>
                <button class="btn btn-secondary w-full mt-md" onclick="Auth.logout()">
                    D√©connexion
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <div class="navbar">
                <div>
                    <h1 class="navbar-title">Tableau de bord</h1>
                    <p class="text-muted" id="welcomeMessage">Bienvenue !</p>
                </div>
                <div class="navbar-actions">
                    <button class="btn btn-primary" onclick="Utils.openModal('addActivityModal')">
                        + Nouvelle activit√©
                    </button>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="grid grid-4 mt-xl">
                <div class="card stat-card">
                    <div class="stat-value" id="statActivites">0</div>
                    <div class="stat-label">Activit√©s</div>
                    <div class="stat-trend positive" id="trendActivites">
                        <span>üìà</span> Cette semaine
                    </div>
                </div>

                <div class="card stat-card">
                    <div class="stat-value" id="statContraintes">0</div>
                    <div class="stat-label">Contraintes actives</div>
                </div>

                <div class="card stat-card">
                    <div class="stat-value" id="statConflits">0</div>
                    <div class="stat-label">Conflits √† r√©soudre</div>
                    <div class="stat-trend negative hidden" id="trendConflits">
                        <span>‚ö†Ô∏è</span> Attention requise
                    </div>
                </div>

                <div class="card stat-card">
                    <div class="stat-value" id="statTaux">100%</div>
                    <div class="stat-label">Taux de r√©solution</div>
                </div>
            </div>

            <!-- Main Grid -->
            <div class="grid grid-2 mt-xl">
                <!-- Today's Activities -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Activit√©s du jour</h3>
                        <a href="activites.html" class="btn btn-sm btn-secondary">Voir tout</a>
                    </div>
                    <div class="card-body" id="todayActivities">
                        <p class="text-muted text-center">Chargement...</p>
                    </div>
                </div>

                <!-- Active Conflicts -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Conflits actifs</h3>
                        <a href="conflits.html" class="btn btn-sm btn-secondary">G√©rer</a>
                    </div>
                    <div class="card-body" id="activeConflicts">
                        <p class="text-muted text-center">Chargement...</p>
                    </div>
                </div>
            </div>

            <!-- Activity Distribution -->
            <div class="card mt-xl">
                <div class="card-header">
                    <h3 class="card-title">R√©partition des activit√©s</h3>
                </div>
                <div class="card-body">
                    <div id="activityDistribution" class="flex gap-md flex-wrap">
                        <!-- Activity type distribution will be rendered here -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Add Activity Modal -->
    <div class="modal-overlay" id="addActivityModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Nouvelle activit√©</h3>
                <button class="modal-close" onclick="Utils.closeModal('addActivityModal')">‚úï</button>
            </div>
            <form id="addActivityForm">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Titre *</label>
                        <input type="text" name="titre" class="form-input" placeholder="Ma nouvelle activit√©" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Type *</label>
                        <select name="typeActivite" class="form-select" required>
                            <option value="Sport">üèÉ Sport</option>
                            <option value="Etude">üìö √âtude</option>
                            <option value="Loisirs">üéÆ Loisirs</option>
                            <option value="Repos">üò¥ Repos</option>
                            <option value="Travail">üíº Travail</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea name="description" class="form-textarea" rows="2"
                            placeholder="Description..."></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Priorit√© (1-10)</label>
                        <input type="number" name="priorite" class="form-input" min="1" max="10" value="5">
                    </div>

                    <div class="form-group">
                        <label class="form-label">D√©but *</label>
                        <input type="datetime-local" name="horaireDebut" class="form-input" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Fin *</label>
                        <input type="datetime-local" name="horaireFin" class="form-input" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Deadline</label>
                        <input type="datetime-local" name="deadline" class="form-input">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary"
                        onclick="Utils.closeModal('addActivityModal')">Annuler</button>
                    <button type="submit" class="btn btn-primary">Cr√©er</button>
                </div>
            </form>
        </div>
    </div>

    <script src="js/utils.js"></script>
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script>
        // Check authentication
        if (!Auth.requireAuth()) {
            throw new Error('Not authenticated');
        }

        const userId = Auth.getUserId();

        // Update user info
        document.getElementById('userName').textContent = Auth.getUserFullName();
        document.getElementById('userAvatar').textContent = Auth.getUserInitials();
        document.getElementById('userEmail').textContent = Auth.getUser()?.email || '';
        document.getElementById('welcomeMessage').textContent = `Bonjour ${Auth.getUser()?.prenom || 'Utilisateur'} !`;

        // Load dashboard data
        async function loadDashboard() {
            try {
                // Load activities
                const activites = await Api.activites.getByUser(userId);
                document.getElementById('statActivites').textContent = activites.length || 0;

                // Filter today's activities
                const today = new Date().toDateString();
                const todayActs = (activites || []).filter(a => {
                    const date = new Date(a.horaireDebut).toDateString();
                    return date === today;
                });

                renderTodayActivities(todayActs);
                renderDistribution(activites || []);

            } catch (error) {
                console.error('Error loading activities:', error);
                document.getElementById('todayActivities').innerHTML =
                    '<p class="text-muted">Impossible de charger les activit√©s</p>';
            }

            try {
                // Load constraints
                const contraintes = await Api.contraintes.getByUser(userId);
                const actives = (contraintes || []).filter(c => c.statut === 'ACTIVE');
                document.getElementById('statContraintes').textContent = actives.length;
            } catch (error) {
                console.error('Error loading constraints:', error);
            }

            try {
                // Load conflicts
                const conflits = await Api.conflits.getUnresolved(userId);
                document.getElementById('statConflits').textContent = (conflits || []).length;

                if ((conflits || []).length > 0) {
                    document.getElementById('trendConflits').classList.remove('hidden');
                }

                renderActiveConflicts(conflits || []);
            } catch (error) {
                console.error('Error loading conflicts:', error);
                document.getElementById('activeConflicts').innerHTML =
                    '<p class="text-muted">Aucun conflit</p>';
            }
        }

        function renderTodayActivities(activities) {
            const container = document.getElementById('todayActivities');

            if (!activities || activities.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">Aucune activit√© aujourd\'hui</p>';
                return;
            }

            container.innerHTML = activities.slice(0, 5).map(act => {
                const type = Utils.getActivityType(act.typeActivite);
                return `
                    <div class="flex items-center justify-between p-sm" style="border-bottom: 1px solid var(--border-light);">
                        <div class="flex items-center gap-md">
                            <span>${type.icon}</span>
                            <div>
                                <div style="font-weight: 500;">${act.titre}</div>
                                <div class="text-muted" style="font-size: 0.875rem;">
                                    ${Utils.formatTime(act.horaireDebut)} - ${Utils.formatTime(act.horaireFin)}
                                </div>
                            </div>
                        </div>
                        <span class="badge badge-${act.typeActivite.toLowerCase()}">${type.label}</span>
                    </div>
                `;
            }).join('');
        }

        function renderActiveConflicts(conflicts) {
            const container = document.getElementById('activeConflicts');

            if (!conflicts || conflicts.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">‚úì Aucun conflit actif</p>';
                return;
            }

            container.innerHTML = conflicts.slice(0, 4).map(conf => {
                const type = Utils.getConflictType(conf.type);
                return `
                    <div class="alert alert-warning mb-sm">
                        <span>${type.icon}</span>
                        <div>
                            <div style="font-weight: 500;">${type.label}</div>
                            <div style="font-size: 0.875rem;">${Utils.formatRelativeTime(conf.horaireDetection)}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderDistribution(activities) {
            const container = document.getElementById('activityDistribution');
            const counts = {};

            activities.forEach(a => {
                counts[a.typeActivite] = (counts[a.typeActivite] || 0) + 1;
            });

            const total = activities.length || 1;

            container.innerHTML = Object.entries(Utils.activityTypes).map(([key, info]) => {
                const count = counts[key] || 0;
                const percent = Math.round((count / total) * 100);
                return `
                    <div style="flex: 1; min-width: 120px; text-align: center; padding: var(--space-md); background: var(--bg-tertiary); border-radius: var(--radius-md);">
                        <div style="font-size: 1.5rem;">${info.icon}</div>
                        <div style="font-weight: 600; font-size: 1.25rem; color: ${info.color};">${count}</div>
                        <div class="text-muted" style="font-size: 0.75rem;">${info.label} (${percent}%)</div>
                    </div>
                `;
            }).join('');
        }

        // Add activity form
        document.getElementById('addActivityForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = Utils.getFormData(e.target);
            data.idUtilisateur = userId;

            try {
                await Api.activites.create(data);
                Utils.toast('Activit√© cr√©√©e !', 'success');
                Utils.closeModal('addActivityModal');
                e.target.reset();
                loadDashboard();
            } catch (error) {
                Utils.toast(error.message || 'Erreur lors de la cr√©ation', 'danger');
            }
        });

        // Initial load
        loadDashboard();
    </script>
</body>

</html>