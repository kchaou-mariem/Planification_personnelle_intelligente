<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conflits - Planification Personnelle</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <script src="js/utils.js"></script>
<script src="js/api.js"></script>
<script src="js/auth.js"></script>
<script>
    // Prot√©ger la page - rediriger si non connect√©
    if (!Auth.requireAuth()) {
        // La redirection est d√©j√† faite par requireAuth()
    }
    
    // Charger les infos utilisateur
    const currentUser = Auth.getUser();
    console.log('Utilisateur connect√©:', currentUser);
</script>
    <style>
        .conflict-card {
            display: flex;
            align-items: flex-start;
            gap: var(--space-md);
            padding: var(--space-lg);
            background: var(--bg-secondary);
            border-left: 4px solid var(--accent-warning);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-md);
        }

        .conflict-card.resolved {
            border-left-color: var(--accent-success);
            opacity: 0.7;
        }

        .conflict-card.high {
            border-left-color: var(--accent-danger);
        }

        .conflict-icon {
            font-size: 2rem;
        }

        .conflict-content {
            flex: 1;
        }

        .conflict-title {
            font-weight: 600;
            margin-bottom: var(--space-xs);
        }

        .conflict-activities {
            background: var(--bg-tertiary);
            padding: var(--space-md);
            border-radius: var(--radius-md);
            margin-top: var(--space-md);
        }

        .stat-row {
            display: flex;
            gap: var(--space-lg);
            margin-bottom: var(--space-xl);
            flex-wrap: wrap;
        }

        .stat-box {
            flex: 1;
            min-width: 150px;
            padding: var(--space-lg);
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            text-align: center;
        }

        .stat-box-value {
            font-size: 2rem;
            font-weight: 700;
        }

        .stat-box-label {
            color: var(--text-muted);
            font-size: 0.875rem;
        }
    </style>
</head>

<body>
    <div class="page-wrapper">
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">üìÖ</div><span class="sidebar-brand">Planificateur</span>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Menu</div>
                    <a href="dashboard.html" class="nav-item"><span class="nav-icon">üìä</span><span
                            class="nav-label">Tableau de bord</span></a>
                    <a href="activites.html" class="nav-item"><span class="nav-icon">üìå</span><span
                            class="nav-label">Activit√©s</span></a>
                    <a href="contraintes.html" class="nav-item"><span class="nav-icon">‚è∞</span><span
                            class="nav-label">Contraintes</span></a>
                    <a href="conflits.html" class="nav-item active"><span class="nav-icon">‚ö†Ô∏è</span><span
                            class="nav-label">Conflits</span></a>
                            <a href="calendrier.html" class="nav-item">
                        <span class="nav-icon">üìÜ</span>
                        <span class="nav-label">Calendrier</span>
                    </a>
  
                    <a href="statistiques.html" class="nav-item">
                        <span class="nav-icon">üìà</span>
                        <span class="nav-label">Statistiques</span>
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Param√®tres</div>
                    <a href="profil.html" class="nav-item"><span class="nav-icon">üë§</span><span class="nav-label">Mon
                            profil</span></a>
                    <a href="#" class="nav-item" onclick="Utils.toggleTheme(); return false;"><span
                            class="nav-icon">üåì</span><span class="nav-label">Th√®me</span></a>
                </div>
            </nav>
            <div class="sidebar-footer">
                <div class="user-card">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <div class="user-info">
                        <div class="user-name" id="userName">Utilisateur</div>
                    </div>
                </div>
                <button class="btn btn-secondary w-full mt-md" onclick="Auth.logout()">D√©connexion</button>
            </div>
        </aside>

        <main class="main-content">
            <div class="navbar">
                <h1 class="navbar-title">Gestion des Conflits</h1>
                <button class="btn btn-primary" onclick="detectConflicts()">üîç D√©tecter les conflits</button>
            </div>

            <!-- Stats -->
            <div class="stat-row mt-xl">
                <div class="stat-box">
                    <div class="stat-box-value text-danger" id="statUnresolved">0</div>
                    <div class="stat-box-label">Non r√©solus</div>
                </div>
                <div class="stat-box">
                    <div class="stat-box-value text-success" id="statResolved">0</div>
                    <div class="stat-box-label">R√©solus</div>
                </div>
                <div class="stat-box">
                    <div class="stat-box-value" id="statRate">100%</div>
                    <div class="stat-box-label">Taux de r√©solution</div>
                </div>
            </div>

            <!-- Filters -->
            <div class="flex gap-md mb-lg">
                <button class="btn btn-primary" id="filterAll">Tous</button>
                <button class="btn btn-secondary" id="filterUnresolved">Non r√©solus</button>
                <button class="btn btn-secondary" id="filterResolved">R√©solus</button>
            </div>

            <!-- Conflicts List -->
            <div id="conflictsList">
                <p class="text-center text-muted">Chargement...</p>
            </div>
        </main>
    </div>

    <script src="js/utils.js"></script>
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script>
        if (!Auth.requireAuth()) throw new Error('Not authenticated');
        const userId = Auth.getUserId();
        let conflicts = [];
        let filter = 'all';

        document.getElementById('userName').textContent = Auth.getUserFullName();
        document.getElementById('userAvatar').textContent = Auth.getUserInitials();

        async function loadConflicts() {
            try {
                conflicts = await Api.conflits.getByUser(userId) || [];
                updateStats();
                renderConflicts();
            } catch (error) {
                document.getElementById('conflictsList').innerHTML = '<p class="text-center text-muted">Erreur de chargement</p>';
            }
        }

        function updateStats() {
            const unresolved = conflicts.filter(c => !c.resolu).length;
            const resolved = conflicts.filter(c => c.resolu).length;
            const total = conflicts.length || 1;
            const rate = Math.round((resolved / total) * 100);

            document.getElementById('statUnresolved').textContent = unresolved;
            document.getElementById('statResolved').textContent = resolved;
            document.getElementById('statRate').textContent = rate + '%';
        }

        function renderConflicts() {
            const container = document.getElementById('conflictsList');

            let filtered = conflicts;
            if (filter === 'unresolved') filtered = conflicts.filter(c => !c.resolu);
            if (filter === 'resolved') filtered = conflicts.filter(c => c.resolu);

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="text-center" style="padding: var(--space-2xl);">
                        <div style="font-size: 4rem;">‚úÖ</div>
                        <h3>${filter === 'all' ? 'Aucun conflit' : 'Aucun conflit dans cette cat√©gorie'}</h3>
                        <p class="text-muted">Votre planning est optimis√© !</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filtered.map(c => {
                const type = Utils.getConflictType(c.type);
                const severity = type.severity === 'high' ? 'high' : '';

                return `
                    <div class="conflict-card ${c.resolu ? 'resolved' : ''} ${severity}">
                        <div class="conflict-icon">${type.icon}</div>
                        <div class="conflict-content">
                            <div class="conflict-title">${type.label}</div>
                            <div class="text-muted" style="font-size: 0.875rem;">
                                D√©tect√© ${Utils.formatRelativeTime(c.horaireDetection)}
                            </div>
                            ${c.resolu ? '<span class="badge badge-success mt-sm">R√©solu</span>' : ''}
                        </div>
                        ${!c.resolu ? `
                            <button class="btn btn-success" onclick="resolveConflict(${c.idConflit})">
                                ‚úì Marquer r√©solu
                            </button>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        async function detectConflicts() {
            try {
                Utils.showLoading();
                const detected = await Api.conflits.detect(userId);
                Utils.hideLoading();

                if (detected && detected.length > 0) {
                    Utils.toast(`${detected.length} conflit(s) d√©tect√©(s)`, 'warning');
                } else {
                    Utils.toast('Aucun nouveau conflit d√©tect√©', 'success');
                }
                loadConflicts();
            } catch (error) {
                Utils.hideLoading();
                Utils.toast('Erreur lors de la d√©tection', 'danger');
            }
        }

        async function resolveConflict(id) {
            try {
                await Api.conflits.resolve(id);
                Utils.toast('Conflit marqu√© comme r√©solu', 'success');
                loadConflicts();
            } catch (error) {
                Utils.toast('Erreur', 'danger');
            }
        }

        // Filter buttons
        document.getElementById('filterAll').addEventListener('click', () => { filter = 'all'; updateFilterButtons(); renderConflicts(); });
        document.getElementById('filterUnresolved').addEventListener('click', () => { filter = 'unresolved'; updateFilterButtons(); renderConflicts(); });
        document.getElementById('filterResolved').addEventListener('click', () => { filter = 'resolved'; updateFilterButtons(); renderConflicts(); });

        function updateFilterButtons() {
            document.querySelectorAll('.flex.gap-md button').forEach(btn => btn.className = 'btn btn-secondary');
            if (filter === 'all') document.getElementById('filterAll').className = 'btn btn-primary';
            if (filter === 'unresolved') document.getElementById('filterUnresolved').className = 'btn btn-primary';
            if (filter === 'resolved') document.getElementById('filterResolved').className = 'btn btn-primary';
        }

        loadConflicts();
    </script>
</body>

</html>